# üîß MANUAL FIX REQUIRED - Feed Service\n\n## ‚ùå Issue Found\n\nNo arquivo `src/timeline/app/services/feed.service.ts`, existem 2 m√©todos que enviam `undefined` para o backend:\n- `addPost()` (linha 171-209)\n- `addPostAsync()` (linha 212-250)\n\n---\n\n## üéØ The Problem\n\nO backend do MarketMeet usa:\n```javascript\nif (rating !== undefined) {\n  // Add to query\n}\n```\n\nMas o frontend envia:\n```javascript\nrating: produto?.nota || undefined  // ‚Üê This is undefined\n```\n\nJSON.stringify converte `undefined` para `null`, ent√£o o backend recebe:\n```javascript\n{\"rating\": null}  // ‚Üê null !== undefined\n```\n\nEnt√£o o backend adiciona o campo `rating: null` na query, o que pode causar problemas.\n\n---\n\n## ‚úÖ Solution\n\n### Approach 1: Simple Fix (Recommended)\n\nMude o objeto `postData` para **n√£o incluir campos undefined**:\n\n**Replace in addPost() method:**\n```typescript\n// ANTES:\nconst postData = {\n  id_user: this.currentUser.id,\n  caption: content,\n  rating: produto?.nota || undefined,\n  category: produto?.categoria || undefined,\n  product_photo: produto?.imagem || undefined,\n  product_url: produto?.nome || undefined\n};\n\n// DEPOIS:\nconst postData: any = {\n  id_user: this.currentUser.id,\n  caption: content\n};\n\nif (produto) {\n  if (produto.nota !== undefined) postData.rating = produto.nota;\n  if (produto.categoria) postData.category = produto.categoria;\n  if (produto.imagem) postData.product_photo = produto.imagem;\n  if (produto.nome) postData.product_url = produto.nome;\n}\n```\n\n### Approach 2: Using delete\n\nOU, limpar undefined ap√≥s criar o objeto:\n\n```typescript\nconst postData = {\n  id_user: this.currentUser.id,\n  caption: content,\n  rating: produto?.nota || undefined,\n  category: produto?.categoria || undefined,\n  product_photo: produto?.imagem || undefined,\n  product_url: produto?.nome || undefined\n};\n\n// Remove undefined fields\nObject.keys(postData).forEach(key => {\n  if (postData[key] === undefined) {\n    delete postData[key];\n  }\n});\n```\n\n---\n\n## üìç Files That Need Changes\n\n### 1. `src/timeline/app/services/feed.service.ts`\n\n**Line ~171-209: `addPost()` method**\n- Replace `postData` object creation\n- Only add fields if they have values\n\n**Line ~212-250: `addPostAsync()` method**\n- Same change as above\n- Only add fields if they have values\n\n---\n\n## üß™ How to Verify Fix\n\nAfter fixing:\n\n1. Open F12 ‚Üí Console\n2. Create a post WITHOUT product details (only text)\n3. Look at the logged data:\n   ```\n   üì§ Enviando post para backend: {\n     id_user: \"1\",\n     caption: \"Texto do post\"\n   }\n   ```\n   ‚úÖ Should only have `id_user` and `caption`\n\n4. Create a post WITH product details\n5. Check the data:\n   ```\n   üì§ Enviando post para backend: {\n     id_user: \"1\",\n     caption: \"Adorei!\",\n     rating: 5,\n     category: \"Smartphones\",\n     product_photo: \"https://...\",\n     product_url: \"iPhone 15\"\n   }\n   ```\n   ‚úÖ Should only have fields with values\n\n---\n\n## üìù Copy-Paste Ready Code\n\nIf you want the ready-made methods:\n\n### Fixed `addPost()` method:\n```typescript\naddPost(content: string, produto?: { nome: string; categoria: string; nota: number; imagem: string }): void {\n  // Build request with only provided fields\n  const postData: any = {\n    id_user: this.currentUser.id,\n    caption: content\n  };\n\n  // Only add optional fields if they have values\n  if (produto) {\n    if (produto.nota !== undefined) postData.rating = produto.nota;\n    if (producto.categoria) postData.category = produto.categoria;\n    if (produto.imagem) postData.product_photo = produto.imagem;\n    if (produto.nome) postData.product_url = produto.nome;\n  }\n\n  console.log('üì§ Enviando post para backend:', postData);\n\n  this.http.post<any>(`${this.apiUrl}/posts/create`, postData).subscribe({\n    next: (response) => {\n      console.log('‚úÖ Post criado com sucesso:', response);\n      const newPost: Post = {\n        id: response.postId?.toString() || Date.now().toString(),\n        author: this.currentUser,\n        createdAt: new Date(),\n        content: { texto: content },\n        produto: produto ? { id: response.postId?.toString() || '', ...produto } : undefined,\n        interacoes: { curtidas: 0, curtidoPor: [], compartilhamentos: 0 }\n      };\n      this.postsSubject.next([newPost, ...this.postsSubject.value]);\n    },\n    error: (error) => {\n      console.error('‚ùå Erro ao criar post:', error);\n      const newPost: Post = {\n        id: Date.now().toString(),\n        author: this.currentUser,\n        createdAt: new Date(),\n        content: { texto: content },\n        produto: produto ? { id: Date.now().toString(), ...produto } : undefined,\n        interacoes: { curtidas: 0, curtidoPor: [], compartilhamentos: 0 }\n      };\n      this.postsSubject.next([newPost, ...this.postsSubject.value]);\n    }\n  });\n}\n```\n\n### Fixed `addPostAsync()` method:\n```typescript\nasync addPostAsync(content: string, produto?: { nome: string; categoria: string; nota: number; imagem: string }): Promise<void> {\n  const postData: any = {\n    id_user: this.currentUser.id,\n    caption: content\n  };\n\n  if (produto) {\n    if (produto.nota !== undefined) postData.rating = produto.nota;\n    if (produto.categoria) postData.category = produto.categoria;\n    if (produto.imagem) postData.product_photo = produto.imagem;\n    if (produto.nome) postData.product_url = produto.nome;\n  }\n\n  try {\n    const response = await this.http.post<any>(`${this.apiUrl}/posts/create`, postData).toPromise();\n    console.log('‚úÖ Post criado com sucesso:', response);\n    const newPost: Post = {\n      id: response?.postId?.toString() || Date.now().toString(),\n      author: this.currentUser,\n      createdAt: new Date(),\n      content: { texto: content },\n      produto: produto ? { id: response?.postId?.toString() || '', ...produto } : undefined,\n      interacoes: { curtidas: 0, curtidoPor: [], compartilhamentos: 0 }\n    };\n    this.postsSubject.next([newPost, ...this.postsSubject.value]);\n  } catch (error) {\n    console.error('‚ùå Erro ao criar post:', error);\n    const newPost: Post = {\n      id: Date.now().toString(),\n      author: this.currentUser,\n      createdAt: new Date(),\n      content: { texto: content },\n      produto: produto ? { id: Date.now().toString(), ...produto } : undefined,\n      interacoes: { curtidas: 0, curtidoPor: [], compartilhamentos: 0 }\n    };\n    this.postsSubject.next([newPost, ...this.postsSubject.value]);\n  }\n}\n```\n\n---\n\n## ‚ö†Ô∏è Important\n\nThis is a **SMALL but IMPORTANT fix**. The backend won't fail, but it might:\n- Insert `NULL` values into the database\n- Not match the `!== undefined` check\n- Cause issues when you try to retrieve posts\n\n**Make sure to apply this fix before testing!**\n\n---\n\n**Estimated Time to Fix:** 2 minutes\n**Difficulty:** Easy\n**Impact:** Critical for correct functionality\n