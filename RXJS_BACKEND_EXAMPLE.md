# ğŸ”¥ RxJS no Express - Exemplo PrÃ¡tico (Seu Projeto)\n\n## ğŸ“‹ Caso de Uso: Sistema de Posts com RxJS\n\n---\n\n## âœ… 1. ServiÃ§o de AutenticaÃ§Ã£o com RxJS\n\n```typescript\n// auth.service.ts\nimport { of, throwError } from 'rxjs';\nimport { mergeMap, tap, map, catchError } from 'rxjs/operators';\nimport jwt from 'jsonwebtoken';\n\nconst JWT_SECRET = 'seu_secret_key';\n\nconst loginUser = (email: string, password: string) => {\n  return of({ email, password })\n    .pipe(\n      // 1ï¸âƒ£ Validar formato de email\n      tap(cred => {\n        if (!cred.email || !cred.password) {\n          throw new Error('Email e senha sÃ£o obrigatÃ³rios');\n        }\n      }),\n      \n      // 2ï¸âƒ£ Buscar usuÃ¡rio no banco\n      mergeMap(cred => \n        findUserByEmail(cred.email).pipe(\n          catchError(() => throwError(() => new Error('UsuÃ¡rio nÃ£o encontrado')))\n        )\n      ),\n      \n      // 3ï¸âƒ£ Validar senha\n      tap(user => {\n        // Aqui vocÃª compararia com bcrypt\n        if (password !== 'senha_do_usuario') {\n          throw new Error('Senha incorreta');\n        }\n      }),\n      \n      // 4ï¸âƒ£ Gerar JWT\n      map(user => ({\n        user,\n        token: jwt.sign(\n          { id: user.id, email: user.email },\n          JWT_SECRET,\n          { expiresIn: '24h' }\n        )\n      })),\n      \n      // 5ï¸âƒ£ Log de sucesso\n      tap(result => {\n        console.log(`âœ… Login bem-sucedido: ${result.user.email}`);\n      }),\n      \n      // Tratamento de erro\n      catchError(err => {\n        console.error(`âŒ Erro no login: ${err.message}`);\n        return throwError(() => err);\n      })\n    );\n};\n\n// FunÃ§Ã£o auxiliar\nconst findUserByEmail = (email: string) => {\n  // Simular busca no banco\n  return of({\n    id: 1,\n    email,\n    username: 'usuario'\n  });\n};\n\nexport { loginUser };\n```\n\n### Usar no Controller:\n```typescript\nrouter.post('/api/users/login', (req, res) => {\n  const { email, password } = req.body;\n\n  loginUser(email, password).subscribe({\n    next: (result) => {\n      res.json({\n        success: true,\n        token: result.token,\n        user: result.user\n      });\n    },\n    error: (err) => {\n      res.status(401).json({\n        error: err.message\n      });\n    }\n  });\n});\n```\n\n---\n\n## âœ… 2. ServiÃ§o de Posts com RxJS\n\n```typescript\n// post.service.ts\nimport { of, combineLatest } from 'rxjs';\nimport { mergeMap, map, tap, filter, catchError } from 'rxjs/operators';\n\n// Banco de dados simulado\nlet postsDB = [\n  { id_post: 1, id_user: 1, caption: 'Post 1', rating: 5, likes_count: 10 },\n  { id_post: 2, id_user: 2, caption: 'Post 2', rating: 4, likes_count: 5 }\n];\n\nconst createPost = (userId: number, postData: any) => {\n  return of(postData)\n    .pipe(\n      // 1ï¸âƒ£ Validar campos obrigatÃ³rios\n      filter(data => {\n        if (!data.caption) {\n          throw new Error('Caption Ã© obrigatÃ³rio');\n        }\n        return true;\n      }),\n      \n      // 2ï¸âƒ£ Validar rating (1-5)\n      filter(data => {\n        if (data.rating && (data.rating < 1 || data.rating > 5)) {\n          throw new Error('Rating deve estar entre 1 e 5');\n        }\n        return true;\n      }),\n      \n      // 3ï¸âƒ£ Verificar se usuÃ¡rio existe\n      mergeMap(data => \n        findUserById(userId).pipe(\n          map(user => ({ ...data, id_user: user.id }))\n        )\n      ),\n      \n      // 4ï¸âƒ£ Salvar no banco\n      map(data => ({\n        id_post: Math.max(...postsDB.map(p => p.id_post)) + 1,\n        ...data,\n        created_at: new Date(),\n        likes_count: 0,\n        comments_count: 0\n      })),\n      \n      tap(newPost => {\n        postsDB.push(newPost);\n        console.log(`âœ… Post criado: ${newPost.id_post}`);\n      }),\n      \n      catchError(err => {\n        console.error(`âŒ Erro ao criar post: ${err.message}`);\n        return throwError(() => err);\n      })\n    );\n};\n\nconst getPostsTimeline = (userId: number) => {\n  return of(postsDB)\n    .pipe(\n      // 1ï¸âƒ£ Filtrar posts relevantes\n      map(posts => posts.filter(p => p.id_user !== userId || p.id_user === userId)),\n      \n      // 2ï¸âƒ£ Enriquecer com dados do usuÃ¡rio\n      mergeMap(posts =>\n        combineLatest(\n          posts.map(post =>\n            findUserById(post.id_user).pipe(\n              map(user => ({\n                ...post,\n                author: {\n                  id: user.id,\n                  username: user.username\n                }\n              }))\n            )\n          )\n        )\n      ),\n      \n      // 3ï¸âƒ£ Ordenar por mais recentes\n      map(posts => posts.sort((a, b) => b.id_post - a.id_post)),\n      \n      // 4ï¸âƒ£ Log\n      tap(posts => console.log(`âœ… ${posts.length} posts carregados`)),\n      \n      catchError(err => {\n        console.error(`âŒ Erro ao carregar timeline: ${err.message}`);\n        return of([]);\n      })\n    );\n};\n\nconst toggleLike = (postId: number, userId: number) => {\n  return of(postId)\n    .pipe(\n      // Encontrar post\n      mergeMap(id => \n        findPostById(id).pipe(\n          tap(post => {\n            if (!post) throw new Error('Post nÃ£o encontrado');\n          })\n        )\n      ),\n      \n      // Verificar se jÃ¡ foi liked\n      mergeMap(post =>\n        checkIfLiked(postId, userId).pipe(\n          map(liked => ({ post, liked }))\n        )\n      ),\n      \n      // Atualizar like count\n      map(({ post, liked }) => ({\n        ...post,\n        likes_count: liked ? post.likes_count - 1 : post.likes_count + 1\n      })),\n      \n      tap(post => console.log(`âœ… Like atualizado: ${post.likes_count}`)),\n      \n      catchError(err => throwError(() => err))\n    );\n};\n\n// FunÃ§Ãµes auxiliares\nconst findUserById = (id: number) => {\n  return of({\n    id,\n    username: `usuario_${id}`,\n    email: `user${id}@email.com`\n  });\n};\n\nconst findPostById = (id: number) => {\n  const post = postsDB.find(p => p.id_post === id);\n  return post ? of(post) : throwError(() => new Error('Post nÃ£o encontrado'));\n};\n\nconst checkIfLiked = (postId: number, userId: number) => {\n  // SimulaÃ§Ã£o: 50% de chance de jÃ¡ ter sido liked\n  return of(Math.random() > 0.5);\n};\n\nexport { createPost, getPostsTimeline, toggleLike };\n```\n\n### Usar no Controller:\n```typescript\nrouter.post('/api/posts/create', (req, res) => {\n  const userId = req.user.id; // Do JWT middleware\n  const postData = req.body;\n\n  createPost(userId, postData).subscribe({\n    next: (newPost) => {\n      res.status(201).json(newPost);\n    },\n    error: (err) => {\n      res.status(400).json({ error: err.message });\n    }\n  });\n});\n\nrouter.get('/api/posts/timeline', (req, res) => {\n  const userId = req.user.id;\n\n  getPostsTimeline(userId).subscribe({\n    next: (posts) => {\n      res.json(posts);\n    },\n    error: (err) => {\n      res.status(500).json({ error: err.message });\n    }\n  });\n});\n\nrouter.post('/api/posts/:id/like', (req, res) => {\n  const postId = parseInt(req.params.id);\n  const userId = req.user.id;\n\n  toggleLike(postId, userId).subscribe({\n    next: (post) => {\n      res.json(post);\n    },\n    error: (err) => {\n      res.status(400).json({ error: err.message });\n    }\n  });\n});\n```\n\n---\n\n## âœ… 3. Middleware de AutenticaÃ§Ã£o com RxJS\n\n```typescript\n// auth.middleware.ts\nimport { of, throwError } from 'rxjs';\nimport { mergeMap, tap, catchError } from 'rxjs/operators';\nimport jwt from 'jsonwebtoken';\n\nconst JWT_SECRET = 'seu_secret_key';\n\nconst authMiddleware = (req, res, next) => {\n  const token = req.headers.authorization?.split(' ')[1];\n\n  of(token)\n    .pipe(\n      // 1ï¸âƒ£ Verificar se token existe\n      tap(t => {\n        if (!t) throw new Error('Token nÃ£o fornecido');\n      }),\n      \n      // 2ï¸âƒ£ Verificar validade do token\n      mergeMap(t => \n        of(jwt.verify(t, JWT_SECRET)).catch(err => {\n          throw new Error('Token invÃ¡lido');\n        })\n      ),\n      \n      // 3ï¸âƒ£ Buscar usuÃ¡rio\n      mergeMap(decoded => \n        findUserById(decoded.id).pipe(\n          tap(user => {\n            if (!user) throw new Error('UsuÃ¡rio nÃ£o encontrado');\n          })\n        )\n      ),\n      \n      catchError(err => {\n        console.error(`âŒ Auth erro: ${err.message}`);\n        return throwError(() => err);\n      })\n    )\n    .subscribe({\n      next: (user) => {\n        req.user = user;\n        next();\n      },\n      error: (err) => {\n        res.status(401).json({ error: 'NÃ£o autorizado' });\n      }\n    });\n};\n\nexport { authMiddleware };\n```\n\n---\n\n## ğŸ“Š Fluxo Completo: Criar Post com RxJS\n\n```\nâ”Œâ”€ POST /api/posts/create â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ { caption: \"...\", rating: 5 }                   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                   â†“\n         â”Œâ”€ of(postData) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                â†“\n         â”Œâ”€ filter: Validar caption â”€â”€â”\n         â”‚ Se falhar: Error âŒ        â”‚\n         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                â†“\n         â”Œâ”€ filter: Validar rating â”€â”€â”€â”\n         â”‚ Se falhar: Error âŒ        â”‚\n         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                â†“\n         â”Œâ”€ mergeMap: findUserById â”€â”€â”€â”\n         â”‚ Buscar usuÃ¡rio no banco    â”‚\n         â”‚ Se nÃ£o encontrar: Error âŒ â”‚\n         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                â†“\n         â”Œâ”€ map: Criar novo post â”€â”€â”€â”€â”€â”\n         â”‚ Gerar ID, timestamp, etc   â”‚\n         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                â†“\n         â”Œâ”€ tap: Salvar no banco â”€â”€â”€â”€â”€â”\n         â”‚ postsDB.push(newPost)      â”‚\n         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                â†“\n         â”Œâ”€ subscribe: Responder â”€â”€â”€â”€â”€â”\n         â”‚ res.status(201).json()     â”‚\n         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## ğŸ¯ Vantagens desta Abordagem\n\nâœ… **Legibilidade:** Pipeline claro e fÃ¡cil de seguir\nâœ… **ComposiÃ§Ã£o:** Operadores reutilizÃ¡veis\nâœ… **Error Handling:** Centralizado com catchError\nâœ… **TransformaÃ§Ãµes:** map, filter, tap naturais\nâœ… **Assincronismo:** mergeMap para operaÃ§Ãµes sequenciais\nâœ… **Logging:** tap para debug sem impactar lÃ³gica\n\n---\n\n## âš ï¸ ConsideraÃ§Ãµes\n\n- RxJS no backend adiciona overhead (bundle size)\n- Equipe precisa conhecer RxJS bem\n- Para CRUD simples, Promises podem ser mais simples\n- Subscribers precisam de error handling obrigatÃ³rio\n\n---\n\n**Agora vocÃª tem um backend com RxJS elegante e funcional! ğŸš€**\n